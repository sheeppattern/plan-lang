{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Plan",
  "scopeName": "source.plan",
  "patterns": [
    { "include": "#frontmatter" },
    { "include": "#comment-block" },
    { "include": "#comment-line" },
    { "include": "#feature-heading" },
    { "include": "#story-heading" },
    { "include": "#task-heading" },
    { "include": "#separator" },
    { "include": "#uncertainty-block-open" },
    { "include": "#uncertainty-block-close" },
    { "include": "#keyword-intent" },
    { "include": "#keyword-behavior" },
    { "include": "#keyword-dependency" },
    { "include": "#keyword-task" },
    { "include": "#keyword-edge" },
    { "include": "#inline-elements" }
  ],
  "repository": {
    "frontmatter": {
      "name": "meta.frontmatter.plan",
      "begin": "\\A---\\s*$",
      "end": "^---\\s*$",
      "beginCaptures": {
        "0": { "name": "punctuation.definition.frontmatter.begin.plan" }
      },
      "endCaptures": {
        "0": { "name": "punctuation.definition.frontmatter.end.plan" }
      },
      "patterns": [
        {
          "match": "^(type|id|status|version|owner|priority|tags|created|updated)(:)",
          "captures": {
            "1": { "name": "entity.name.tag.yaml.plan" },
            "2": { "name": "punctuation.separator.key-value.yaml.plan" }
          }
        },
        {
          "match": "(draft|ready|in_progress|blocked|done|deprecated)",
          "name": "constant.language.status.plan"
        },
        {
          "match": "(feature|story|task)",
          "name": "constant.language.type.plan"
        },
        {
          "match": "(urgent|high|normal|low)",
          "name": "constant.language.priority.plan"
        },
        {
          "match": "@[a-zA-Z_][a-zA-Z0-9_-]*",
          "name": "variable.other.actor.plan"
        },
        {
          "name": "string.quoted.brackets.yaml.plan",
          "begin": "\\[",
          "end": "\\]",
          "patterns": [
            { "match": "[^,\\]]+", "name": "string.unquoted.yaml.plan" }
          ]
        }
      ]
    },

    "comment-block": {
      "name": "comment.block.plan",
      "begin": "<!--",
      "end": "-->",
      "beginCaptures": {
        "0": { "name": "punctuation.definition.comment.begin.plan" }
      },
      "endCaptures": {
        "0": { "name": "punctuation.definition.comment.end.plan" }
      }
    },

    "comment-line": {
      "name": "comment.block.plan",
      "match": "<!--.*-->"
    },

    "feature-heading": {
      "match": "^(#)\\s+(Feature:)\\s*(.*)",
      "captures": {
        "1": { "name": "punctuation.definition.heading.plan" },
        "2": { "name": "keyword.control.feature.plan" },
        "3": { "name": "markup.heading.feature.plan" }
      }
    },

    "story-heading": {
      "match": "^(##)\\s+(Story:)\\s*(.*)",
      "captures": {
        "1": { "name": "punctuation.definition.heading.plan" },
        "2": { "name": "keyword.control.story.plan" },
        "3": { "name": "markup.heading.story.plan" }
      }
    },

    "task-heading": {
      "match": "^(###)\\s+(Task:)\\s*(.*)",
      "captures": {
        "1": { "name": "punctuation.definition.heading.plan" },
        "2": { "name": "keyword.control.task.plan" },
        "3": { "name": "markup.heading.task.plan" }
      }
    },

    "separator": {
      "match": "^---\\s*$",
      "name": "meta.separator.plan"
    },

    "uncertainty-block-open": {
      "match": "^\\s*(\\?(pending|assumption|alternative|risk))\\s+[\"\\u201c]([^\"\\u201d]*)[\"\\u201d]?",
      "captures": {
        "1": { "name": "entity.name.type.uncertainty.plan" },
        "2": { "name": "entity.name.type.uncertainty-type.plan" },
        "3": { "name": "string.quoted.uncertainty-message.plan" }
      }
    },

    "uncertainty-block-close": {
      "match": "^\\s*(\\?end)\\s*$",
      "captures": {
        "1": { "name": "entity.name.type.uncertainty.plan" }
      }
    },

    "keyword-intent": {
      "match": "^\\s*(Goal|Persona|Metric)(:)\\s*(.*)",
      "captures": {
        "1": { "name": "keyword.control.intent.plan" },
        "2": { "name": "punctuation.separator.keyword.plan" },
        "3": {
          "patterns": [{ "include": "#inline-elements" }]
        }
      }
    },

    "keyword-behavior": {
      "match": "^\\s*(Given|When|Then)(:)\\s*(.*)",
      "captures": {
        "1": { "name": "keyword.control.behavior.plan" },
        "2": { "name": "punctuation.separator.keyword.plan" },
        "3": {
          "patterns": [{ "include": "#inline-elements" }]
        }
      }
    },

    "keyword-dependency": {
      "match": "^\\s*(Needs|Blocks)(:)\\s*(.*)",
      "captures": {
        "1": { "name": "keyword.control.dependency.plan" },
        "2": { "name": "punctuation.separator.keyword.plan" },
        "3": {
          "patterns": [{ "include": "#inline-elements" }]
        }
      }
    },

    "keyword-task": {
      "match": "^\\s*(Assign|Verify)(:)\\s*(.*)",
      "captures": {
        "1": { "name": "keyword.control.task-keyword.plan" },
        "2": { "name": "punctuation.separator.keyword.plan" },
        "3": {
          "patterns": [{ "include": "#inline-elements" }]
        }
      }
    },

    "keyword-edge": {
      "match": "^\\s*(Edge)(:)\\s*(.*)",
      "captures": {
        "1": { "name": "keyword.control.edge.plan" },
        "2": { "name": "punctuation.separator.keyword.plan" },
        "3": { "name": "string.unquoted.edge-description.plan" }
      }
    },

    "inline-elements": {
      "patterns": [
        { "include": "#obligation" },
        { "include": "#uncertainty-inline" },
        { "include": "#plan-reference" },
        { "include": "#actor-reference" },
        { "include": "#backtick-code" }
      ]
    },

    "obligation": {
      "match": "\\[(MUST|SHOULD|MAY)\\]",
      "name": "constant.language.obligation.plan"
    },

    "uncertainty-inline": {
      "match": "\\?(pending|assumption|alternative|risk)\\([\"\\u201c]([^\"\\u201d]*)[\"\\u201d]\\)",
      "captures": {
        "0": { "name": "entity.name.type.uncertainty.plan" }
      }
    },

    "plan-reference": {
      "match": "\\[([a-zA-Z][a-zA-Z0-9_:-]*(?:#[a-zA-Z0-9_-]+)?)\\]",
      "name": "entity.name.tag.reference.plan"
    },

    "actor-reference": {
      "match": "@[a-zA-Z_][a-zA-Z0-9_-]*",
      "name": "variable.other.actor.plan"
    },

    "backtick-code": {
      "match": "`[^`]+`",
      "name": "markup.inline.raw.string.plan"
    }
  }
}
